name: Update Match Schedules

on:
  workflow_dispatch: {}
  schedule:
    # 每天 UTC 20:00 触发 ≈ 北京时间次日 04:00
    - cron: "0 20 * * *"

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      # ★ 你的爬虫：保持你原来能产出 schedule_2025.json / schedule_2026.json 的命令
      - name: Run scraper (produce schedule_2025.json & schedule_2026.json)
        env:
          TZ: Asia/Shanghai
        run: |
          python scripts/scrape_teams.py

      # ★ 生成合并的 ICS
      - name: Build merged ICS
        run: |
          mkdir -p data/ics
          python scripts/make_ics.py \
            --in data/schedule_2025.json data/schedule_2026.json \
            --out data/ics/matches_all.ics \
            --name "Louis_Zeng 赛事合订(2025-2026)"

      # ★ 确认 .ics 真的生成了
      - name: Verify ICS exists
        run: |
          test -s data/ics/matches_all.ics || (echo "ICS not found or empty" && exit 1)

      # ★ 禁用 Jekyll，确保 .ics 会被 GitHub Pages 发布
      - name: Add .nojekyll
        run: |
          touch .nojekyll

      # ★ 调试文件（可选）：把原始页面快照/解析结果放到 data/_debug（如果你脚本会产出）
      - name: Ensure debug dir
        run: |
          mkdir -p data/_debug

      # ★ 提交改动
      - name: Commit & push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-update schedules & ics ${{ github.run_id }}"
          file_pattern: |
            data/schedule_*.json
            data/_debug/**
            data/ics/*.ics
            .nojekyll
            
