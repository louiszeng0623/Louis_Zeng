name: Update Match Schedules

on:
  workflow_dispatch:
  # 每天凌晨 4 点（北京时间）自动跑；GitHub 用 UTC，这里 20:00=次日 04:00(北京)
  schedule:
    - cron: '0 20 * * *'

concurrency:
  group: 'update-schedule'
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Run scraper
        env:
          TZ: Asia/Shanghai
        run: |
          mkdir -p data/_debug
          # 抓“成都蓉城 & 国际米兰”，年份 2025/2026，输出到 data/ 下
          python scripts/scrape_teams.py \
            --teams "成都蓉城" "国际米兰" \
            --years 2025 2026 \
            --out data

      - name: Build merged ICS
        run: |
          mkdir -p data/ics
          python scripts/make_ics.py \
            --inputs data/schedule_2025.json data/schedule_2026.json \
            --out data/ics/matches_all.ics \
            --title "Louis_Zeng 合并赛程 (2025-2026)"

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-snapshots
          path: |
            data/_debug/**
            data/schedule_*.json
            data/ics/*.ics
          if-no-files-found: warn
          retention-days: 7

      - name: Commit & push (safe merge)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: auto-update schedules & ics $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git pull --rebase origin main || true
          git push origin main
